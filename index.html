<!DOCTYPE html>
<html lang="en">
	<head>
		<title>pointCloud</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>

			body {
				color: #000;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;

				background-color: #fff;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				color:#000;
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;

			}

			a {
				color: green;
        text-decoration: none;
			}

      .noselect {
        /*pointer-events: none;*/
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none; /* Chrome/Safari/Opera */
        -khtml-user-select: none; /* Konqueror */
        -moz-user-select: none; /* Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
        user-select: none; /* Non-prefixed version, currently
                                  not supported by any browser */
      }

		</style>
	</head>

	<body>
		<div id="container"></div>
		<div id="info" class="">
      <span>pointCloud - <a href="https://github.com/jonathanlurie/pointCloud" target="_blank">see on Github</a></span>
      <p>(Open space/tab separated 3D coordinates list)</p>
      <p id="loadInfo"></p>
      <input type="file" id="myFile" style="display: none;">
		</div>

    <!-- THREE stuff -->
		<script src="js/three.js"></script>
		<script src="js/TrackballControls.js"></script>
    <script src="js/Lut.js"></script>
		<script src="js/Detector.js"></script>
		<script src="js/stats.min.js"></script>
    <script src="js/dat.gui.js"></script>


    <!-- MINC related things -->

    <script src="js/papaparse.js"></script>
    <script src="js/pako.js"></script>

		<script>

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var stats;

			var camera, controls, scene, renderer;

      var mincData = null;
      var nonLinearPoints = [];

      // will contain all the shapes
      var mainContainer;

      var pointCloud = null;
      var dataAvgPosition = new THREE.Vector3();

      // variable managed by DAT.GUI
      var guiVar = null;
      var gui = new dat.GUI();

			init();
			animate();


      // initialize the UI
      function initDatGui(){

        guiVar = {


          debug: function(){
              console.log("DEBUG");
          },

          // just shortcut to load a minc file
          loadFile: function(){
            document.getElementById('myFile').click();
          },



        };


        gui.add(guiVar, "loadFile");
        gui.add(guiVar, "debug");

      }


      // INIT
			function init() {

        // init the file opener
        document.getElementById('myFile').addEventListener('change', handleFileSelect, false);

        initDatGui();

				scene = new THREE.Scene();

        var axisHelper = new THREE.AxisHelper( 1 );
        scene.add( axisHelper );

				//scene.fog = new THREE.FogExp2( 0xcccccc, 0.002 );

				renderer = new THREE.WebGLRenderer(/*{antialias: true}*/);
				//renderer.setClearColor( scene.fog.color );
        renderer.setClearColor( new THREE.Color().setRGB( 0.95, 0.95, 0.95 ) );

				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );

				var container = document.getElementById( 'container' );
				container.appendChild( renderer.domElement );

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.1, 10000 );
				camera.position.z = 10;

				controls = new THREE.TrackballControls( camera, renderer.domElement );
        controls.addEventListener( 'change', render );
				//controls.addEventListener( 'change', render ); // add this only if there is no animation loop (requestAnimationFrame)
        controls.rotateSpeed = 10.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;
				controls.noZoom = false;
				controls.noPan = false;
				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

        // Object hierarchy
        mainContainer = new THREE.Object3D();
        scene.add(mainContainer);

        //var axisHelper = new THREE.AxisHelper( 5 );
        //scene.add(axisHelper);

				stats = new Stats();
				container.appendChild( stats.dom );


        //

				window.addEventListener( 'resize', onWindowResize, false );

			}


      // ON RESIZE
			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}


      // ANIMATE
			function animate() {
				requestAnimationFrame( animate );
				controls.update(); // required if controls.enableDamping = true, or if controls.autoRotate = true
				stats.update();
				render();
			}


      // RENDER
			function render() {
				renderer.render( scene, camera );
			}






      function addParticles(){

        var nbParticles = nonLinearPoints.length;

        var geometry = new THREE.BufferGeometry();
				var positions = new Float32Array( nbParticles * 3 );
				var colors = new Float32Array( nbParticles * 3 );
				var color = new THREE.Color( 0xff0000 );

        var iterator = 0;


        for(var i=0; i<nbParticles; i++){

          // positions
          positions[ iterator ]     = nonLinearPoints[i][0];
					positions[ iterator + 1 ] = nonLinearPoints[i][1];
					positions[ iterator + 2 ] = nonLinearPoints[i][2];

          // colors
          colors[ iterator ]     = 1; //color.r;
					colors[ iterator + 1 ] = 0; //color.g;
					colors[ iterator + 2 ] = 0; //color.b;

          iterator += 3;
        }

        console.log(nonLinearPoints);
        console.log(positions);

        geometry.addAttribute( 'position', new THREE.BufferAttribute( positions.subarray(0, iterator), 3 ) );
				geometry.addAttribute( 'color', new THREE.BufferAttribute( colors.subarray(0, iterator), 3 ) );
        geometry.computeBoundingSphere();
        console.log(geometry);
				var material = new THREE.PointsMaterial( { size: 0.01, vertexColors: THREE.VertexColors } );

				pointCloud = new THREE.Points( geometry, material );
				mainContainer.add( pointCloud );

        camera.position.x = dataAvgPosition.x + geometry.boundingSphere.radius;
        camera.position.y = dataAvgPosition.y + geometry.boundingSphere.radius;
        camera.position.z = dataAvgPosition.z + geometry.boundingSphere.radius;
        camera.updateProjectionMatrix();
        //controls.reset();

        //camera.lookAt( dataAvgPosition.clone() );

        //controls.target = dataAvgPosition.clone();
        controls.target.copy( dataAvgPosition );
        //controls.reset();


        console.log(camera);
        console.log(dataAvgPosition);

        /*
        var axisHelper = new THREE.AxisHelper( 5 );
        axisHelper.position.x = dataAvgPosition.x;
        axisHelper.position.y = dataAvgPosition.y;
        axisHelper.position.z = dataAvgPosition.z;
        scene.add( axisHelper );
        */




    }


    // TODO: make it only for a single file (not i)
    // Deals with opening the MIN file
    function handleFileSelect(evt) {
      var files = evt.target.files; // FileList object

      if(files.length == 0)
        return;

      var counter = 0;

      // Stream big file in worker thread
      Papa.parse(files[0], {
        delimiter: ' ',
      	worker: true,

      	step: function(results) {
          if(results.data.length )

      		//console.log("Row:", results);
          //console.log(results.data);

          // if no error && sone data
          if(!results.errors.length && results.data.length ){

            if(results.data[0].length != 3)
              return;

            var  xyz = [
              parseFloat(results.data[0][0]),
              parseFloat(results.data[0][1]),
              parseFloat(results.data[0][2])
            ]
            nonLinearPoints.push( xyz );

            dataAvgPosition.x += xyz[0];
            dataAvgPosition.y += xyz[1];
            dataAvgPosition.z += xyz[2];

            printLoadInfo( counter + " points parsed...");
            counter++;
          }
      	},

        complete: function(results) {
          console.log("all " + nonLinearPoints.length + " points parsed.");
          printLoadInfo( "" );

          dataAvgPosition.x /= counter;
          dataAvgPosition.y /= counter;
          dataAvgPosition.z /= counter;

          addParticles();
	      }

      });


    }



    function printLoadInfo( s ){
      document.getElementById("loadInfo").innerHTML = s;
    }


		</script>

	</body>
</html>
